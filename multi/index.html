<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>블록 전쟁 — 클리어가 곧 공격 · 멀티</title>
  <style>
    :root{--bg:#0f1226;--fg:#e6e9ff;--muted:#9aa0c3;--accent:#5dd1ff;--panel:#171a36;--grid:#1f2347}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 800px at 70% 20%,#14173b,var(--bg));color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial;display:grid;grid-template-rows:auto auto;align-content:start;gap:16px;padding:72px 16px 40px;overflow-x:hidden}
    .topbar{position:fixed;top:0;left:0;right:0;height:56px;display:flex;align-items:center;justify-content:center;background:color-mix(in oklab,var(--panel) 85%,black 15%);border-bottom:1px solid #2a2f66;z-index:1000}
    .title{font-weight:700}
    .brand{font-weight:900;letter-spacing:6px;text-transform:uppercase;font-size:clamp(42px,8vw,72px);line-height:1;background:linear-gradient(90deg,#5dd1ff 0%,#ffd95d 100%);-webkit-background-clip:text;background-clip:text;color:transparent;text-shadow:0 2px 0 rgba(0,0,0,.35); margin:4px auto 4px; align-self:start; text-align:center;}
    .panel{background:color-mix(in oklab,var(--panel) 85%,black 15%);border:1px solid #2a2f66;border-radius:12px;padding:12px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .panel.compact{ padding:8px 12px 6px; }
    .row{display:flex;gap:8px;align-items:center}
    .input{background:#0b0e22;border:1px solid #2a2f66;border-radius:6px;color:var(--fg);padding:10px 12px;height:40px;font:inherit}
    .muted{color:var(--muted)} button{background:#0b0e22;color:var(--fg);border:1px solid #2a2f66;border-radius:8px;padding:10px 12px;height:40px;cursor:pointer}
    .panel.compact .input{ height:36px; padding:8px 10px; }
    .panel.compact button{ height:36px; padding:8px 10px; }
    .container{ width:min(960px,92vw); margin: 0 auto; display:grid; gap:8px; }
  </style>
</head>
<body>
  <div class="topbar"><div class="title">BLOCK WAR — 클리어가 곧 공격</div></div>
  <div class="brand" style="margin: 0 0 50px 0 ;">BLOCK WAR</div>
  <div class="container">
  
  <div class="panel">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 8px;">
      <h2 style="margin: 0 8px; font-size:16px;">대기 중인 방</h2>
      <button id="btn-create-room" style="height:32px; padding:6px 12px; font-size:14px;">방 만들기</button>
    </div>
    <div id="room-list" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap:16px; max-height: 420px; overflow:auto;">
      <div class="muted" id="room-empty" style="grid-column:1/-1;display:flex;flex-direction:column;gap:12px;align-items:center;justify-content:center;padding:36px 12px;text-align:center;">현재 대기중인 방이 없습니다.<br/></div>
    </div>
  </div>
  </div>
  <script type="module">
    import { LobbyClient } from '../src/net/lobby.ts';
    const url = import.meta.env.VITE_SUPABASE_URL;
    const anonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;
    if (!url || !anonKey) console.error('Supabase config missing');
    const lobby = new LobbyClient(url, anonKey);
    const roomList = document.getElementById('room-list');
    lobby.onUpdate = (rooms) => {
      if (!roomList) return;
      if (!rooms.length) {
        roomList.innerHTML = '<div class="muted" id="room-empty" style="grid-column:1/-1;display:flex;flex-direction:column;gap:12px;align-items:center;justify-content:center;padding:36px 12px;text-align:center;">현재 대기중인 방이 없습니다.<br/></div>';
        const btn = document.getElementById('room-empty-create');
        btn && btn.addEventListener('click', () => {
          showCreateRoomModal();
        });
        return;
      }
      roomList.innerHTML = rooms.map(r => `<button class="card" data-join="${r.id}" data-title="${r.title||'Room'}" style="display:flex;flex-direction:column;justify-content:space-between;text-align:left;padding:16px;height:110px;background:#0f142f;border:1px solid #2a2f66;border-radius:12px;color:inherit;cursor:pointer;"><div style=\"font-weight:700;font-size:14px;\">${(r.title||'Room')}</div><div style=\"display:flex;justify-content:space-between;font-size:12px;color:#9aa0c3;\"><span>${r.host}</span><span>${r.players}/${r.max}</span></div></button>`).join('');
      roomList.querySelectorAll('button[data-join]').forEach((b) => b.addEventListener('click', (e) => {
        const target = e.currentTarget;
        const id = target && target.dataset ? target.dataset.join : null;
        const title = target && target.dataset ? target.dataset.title : null;
        if (!id) return;
        localStorage.setItem('tetris_room', id);
        localStorage.setItem('tetris_room_title', title || 'Room');
        localStorage.setItem('tetris_room_created', 'false'); // Mark as guest
        window.location.href = '../game/index.html';
      }));
    };
    const savedNick = localStorage.getItem('tetris_nick') || '';
    if (!savedNick) showNicknameModal(); else lobby.join(savedNick);
    function showNicknameModal() {
      const overlay = document.createElement('div');
      overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);display:grid;place-items:center;z-index:2000;';
      const card = document.createElement('div');
      card.className = 'panel';
      card.style.cssText = 'width:min(480px,92vw);';
      card.innerHTML = '<h2 style=\"margin:0 0 8px;\">닉네임 설정</h2><p class=\"muted\" style=\"margin:0 0 8px;\">게임에서 표시될 이름을 입력하세요.</p>';
      const row = document.createElement('div'); row.className = 'row';
      const input = document.createElement('input'); input.className = 'input'; input.placeholder = 'Nickname'; input.style.flex='1 1 auto';
      const btn = document.createElement('button'); btn.textContent = '확인';
      row.appendChild(input); row.appendChild(btn); card.appendChild(row); overlay.appendChild(card);
      document.body.appendChild(overlay); input.focus();
      function commit(){ const v = (input.value||'').trim() || 'Anonymous'; localStorage.setItem('tetris_nick', v); lobby.join(v); document.body.removeChild(overlay); }
      btn.addEventListener('click', commit); input.addEventListener('keydown',(e)=>{ if(e.key==='Enter') commit(); });
    }
    function showCreateRoomModal() {
      const overlay = document.createElement('div');
      overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);display:grid;place-items:center;z-index:2000;';
      const card = document.createElement('div');
      card.className = 'panel';
      card.style.cssText = 'width:min(480px,92vw);';
      card.innerHTML = '<h2 style="margin:0 0 8px;">방 만들기</h2><p class="muted" style="margin:0 0 8px;">멀티플레이 방 제목을 입력하세요.</p>';
      const row = document.createElement('div'); row.className = 'row';
      const input = document.createElement('input'); input.className = 'input'; input.placeholder = '방 제목'; input.style.flex='1 1 auto';
      const btn = document.createElement('button'); btn.textContent = '만들기';
      const cancelBtn = document.createElement('button'); cancelBtn.textContent = '취소'; cancelBtn.style.marginLeft = '4px';
      row.appendChild(input); row.appendChild(btn); row.appendChild(cancelBtn); card.appendChild(row); overlay.appendChild(card);
      document.body.appendChild(overlay); input.focus();
      function create(){ 
        const title = (input.value||'').trim();
        if (!title) { alert('방 제목을 입력하세요'); input.focus(); return; }
        const id = lobby.createRoom(title); 
        localStorage.setItem('tetris_room', id); 
        localStorage.setItem('tetris_room_title', title);
        localStorage.setItem('tetris_room_created', 'true'); // Mark as host
        window.location.href = '../game/index.html';
      }
      function close() { document.body.removeChild(overlay); }
      btn.addEventListener('click', create); 
      cancelBtn.addEventListener('click', close);
      input.addEventListener('keydown',(e)=>{ if(e.key==='Enter') create(); if(e.key==='Escape') close(); });
      overlay.addEventListener('click', (e) => { if(e.target === overlay) close(); });
    }
    
    const btnCreateRoom = document.getElementById('btn-create-room');
    btnCreateRoom && btnCreateRoom.addEventListener('click', () => {
      showCreateRoomModal();
    });
  </script>
</body>
</html>
